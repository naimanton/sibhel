<!doctype html>
<html>
  <head>
    <title>База заказов</title>
    <meta charset="utf8">
    <link 
        id="favicon" 
        rel="icon" 
        href="https://cdn.glitch.global/a3684bc5-4628-411e-86a7-63fef2606aa3/shfavicon.ico?v=1656348357438"
        type="image/x-icon"
      >
    <style>
      body {
        background-color: #fae5be;
/*         background-color: #99cccc; */
      }
      input, select {
        padding: 10px 8px;
      }
      td {
        padding: 15px;
      }
      #resultTextarea {
        position: relative;
        top: 13px;
      }
      #subtractSubmit {
        position: relative;
        top: -13px;
      }
      #RCOrderCheck {
        position: relative;
        top: -13px;
      }
      #RCOrderCheckLabel {
        position: relative;
        top: -13px;
      }
/*       #orderTbody {
        color: white;
      } */
    </style>
  </head>
  <body>
    <table>
      <tbody>
        <tr>
          <td style="vertical-align: top;">
            C<input id="dateFilterInp1" placeholder="От" type="date">По<input id="dateFilterInp2" placeholder="До" type="date">
            <input id="storeFilterInp" placeholder="Склад">
            <input id="filterSub" type="submit" value="Фильтровать"><hr>
            <input id="password" placeholder="Пароль" type="password">
            <input id="delOrder" type="submit" value="Удалить выбранный заказ">
            <textarea id="resultTextarea" placeholder="Здесь появится выбранный заказ"></textarea><hr>
            <span id="filterInfo"></span><br>
            <select id="datesSelect" placeholder="Дата">
            </select><input id="askOrder" type="submit" value="Запросить заказ"><br><hr>
            Отображение и ручное сохранение форматного заказа<br>
            <textarea style="position: relative; top: 12px;" id="noteTextarea" placeholder="Примечание (макс. 60 символов)"></textarea>
            <textarea style="position: relative; top: 12px;" placeholder="Вставить заказ и нажать Ctrl+Delete" id="sendTextarea"></textarea>
            <input id="login" placeholder="Логин">
            <input id="sendOrder" type="submit" value="Отправить заказ"><hr>
            Математика:<br><br>
            <textarea cols="40" id="summator" placeholder="Сумматор заказов. Вставьте заказы разделяя их переносами строки и нажмите Ctrl+Delete"></textarea>
            <br><input type="submit" id="subtractSubmit" value="Вычесть">
            <input type="checkbox" id="RCOrderCheck" checked><label id="RCOrderCheckLabel" for="RCOrderCheck">Уменьшаемый РЦ-заказ</label>
            <textarea id="sumToSubtract" placeholder="Уменьшаемый заказ"></textarea>
            <textarea id="subtractor" placeholder="Вычитамый заказ"></textarea>
            <textarea id="subtractingRes" placeholder="Разность заказов"></textarea>
          </td>
        </tr><tr>
          <td>
            <span id="orderInfoSpan"></span><hr>
            <table>
              <tbody id="orderTbody">
              </tbody>
            </table>
          </td>
        </tr>
      </tbody>
    </table>
    <script>
      var jstr = JSON.stringify;
      var outputDates = [];
      let s = '---';
      var app = {
        try(callback) {
          try { callback() }
          catch (er) { alert(er); console.log(er.stack) }
        },
        a(boolean, msg='Foreseen error') {
          if (boolean) return;
          throw new Error(msg);
        },
        run() {
          sendOrder.addEventListener('click', () => {
              let note;
              if (login.value === '' || sendTextarea.value === '' || noteTextarea.value.length > 60) {
                alert('Укажите склад и вставьте заказ. Проверьте, что примечание не превышает 60 символов.')
                return;
              }
              if (noteTextarea.value.length !== 0) {
                note = noteTextarea.value;
              }
              if (!confirm('Укажите склад и внимательно проверьте заказ перед отправкой. Отправить заказ?')) return;
              app.postFetchObject(
                '/saveOrder', 
                {order: sendTextarea.value, login: login.value, note},
                (r) => alert(JSON.parse(r).message)
              )
          });
          sendTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' && e.ctrlKey && !e.repeat) {
              e.preventDefault();
              if (sendTextarea.value === '') {
                alert('Вставьте заказ.')
                return;
              }
              app.handleOrder(JSON.stringify({
                  message: 'Заказ получен.',
                  order: sendTextarea.value,
              }), 'из ручного режима: ' + login.value + s + noteTextarea.value);
            }
          });
          askOrder.addEventListener('click', () => {
              if (!datesSelect.value.includes(s)) {
                alert('Выберите дату');
                return;
              }
              let spl = datesSelect.value.split(s)
              app.postFetchObject(
                '/askOrder', 
                { date: spl },
                response => app.handleOrder(response, datesSelect.value)
              );
          });
          
           delOrder.addEventListener('click', () => {
              if (!datesSelect.value.includes(s)) {
                alert('Выберите дату');
                return;
              }
              if (password.value === '') {
                alert('Введите пароль.');
                return;
              }
              if(!confirm('Удалить заказ?')) return;
              alert('Запрос...');
              app.postFetchObject(
                '/delOrder', 
                {password: password.value, date: datesSelect.value.split(s)},
                app.handleOrder
              );
          });
          filterSub.addEventListener('click', () => {
            datesSelect.innerHTML = '';
            let datesHTML = '';
            filterInfo.innerText = `Фильтр: ${storeFilterInp.value || 'Любой склад'}; ${dateFilterInp1.value || '---'} - ${dateFilterInp2.value || '---'}`;
            for (let date of outputDates) {
              let dateSpl = date.split(s);
                if (
                  !app.dateBetween(dateSpl[0], dateFilterInp1.value, dateFilterInp2.value) ||
                  !(dateSpl[1].includes(storeFilterInp.value))
                ) continue; 
                datesHTML += `<option value="${date}">${date}</option>`
            }
            datesSelect.insertAdjacentHTML('beforeend', datesHTML);
            return;
            });
          summator.addEventListener('keydown', e => {
            app.try(() => {
              if (e.key !== 'Delete' || e.repeat || !e.ctrlKey) return;
              var sumval = summator.value;
              summator.value = 'Загрузка...';
              setTimeout(() => {
                app.try(()=>{
                  summator.value = app.makeSumOfOrders(sumval);
                });
              }, 2000);
            })
          });
          subtractSubmit.addEventListener('click', () => {
            app.try(() => {
              if (sumToSubtract.value === '') {
                alert("Поле уменьшаемого ничего не содержит.");
                return
              }
              var sumToSub;
              if (RCOrderCheck.checked) {
                sumToSub = app.convertRCOrderToOrder(sumToSubtract.value);
              }
              else {
                sumToSub = sumToSubtract.value;
              }
              subtractingRes.value = app.subtractOrder(sumToSub, subtractor.value);
            });
          });
          app.postFetchObject(
            '/askDates', 
            {},
            app.handleDates
          );
        },
        dateBetween(date1, date0, date2) {
          if (date0 === '' && date2 === '') return true;
          if (date0 === '') {
            date0 = date2;
          }
          if (date2 === '') {
            date2 = date0;
          }
          var ldate0 = date0;
          var ldate2 = date2;
          if (date0 > date2) {
            var tdate0 = ldate0;
            ldate0 = ldate2
            ldate2 = tdate0;
          }
          if (new Date(date1) >= new Date(ldate0) && new Date(date1) <= new Date(ldate2)) return true;
          return false;
        },
        postFetchObject(url, request, callback) {
          let config = {
            method: 'POST',
            body: JSON.stringify(request)
          }
          fetch(url, config).then(p => p.text().then( r => callback(r) ));
        },
        handleDates(response) {
          let r = JSON.parse(response);
          let datesHTML = '';

          if (r.message !== 'Даты получены.') {
            alert(r.message);
            return;
          }
          // r.dates.sort().reverse()
          for (let date of r.dates) {
            outputDates.push(
                date[0]+s+date[1]+s+date[2]+(date[3] ? s+date[3] : '')
            );
          }
          outputDates.sort().reverse();
          for (let date of outputDates) {
            datesHTML += `<option value="${date}">${date}</option>`
          }
          datesSelect.insertAdjacentHTML('beforeend', datesHTML);
        },
        handleOrder(response, orderInfo) {
          let r = JSON.parse(response);
          let orderHTML = '';
          if (r.message !== 'Заказ получен.') {
            alert(r.message);
            return;
          }
          resultTextarea.value = r.order;
          orderInfoSpan.innerText = "Отображается: " + orderInfo;
          for (let pos of r.order.split('\n')) {
            let sp = pos.split('\t');
            orderHTML += `
              <tr>
                <td>${sp[0]}</td>
                <td>${sp[1]}</td>
                <td>${sp[2]}</td>
                <td>${sp[3]}</td>
                <td>${sp[4]}</td>
              </tr>
            `;
          }
          orderTbody.innerHTML = orderHTML;
        },
        convertOrderToObject(order) {
          var result = {};
          var orderSpl = order.split('\n');
          for (var line of orderSpl) {
            var lineSpl = line.split('\t');
            if (["Код","Итог:"].includes(lineSpl[0])) continue;
            if (result[lineSpl[0]] === undefined) {
              result[lineSpl[0]] = {
                name: lineSpl[1],
                amount: +lineSpl[2],
                coins: lineSpl[3],
                price: lineSpl[4]
              };
              continue;
            }
            result[lineSpl[0]].amount += +lineSpl[2];            
          }
          return result;
        },
        convertObjectToOrder(object) {
          var result = 'Код\tНаименование\tКол-во\tБаллы\tЦена\n';
          var sum = {amount:0, coins:0, price:0};
          for (var code in object) {
            sum.amount += +object[code].amount;
            sum.coins += +object[code].coins * +object[code].amount;
            sum.price += +object[code].price * +object[code].amount;
            result += `${code}\t${object[code].name}\t${object[code].amount}\t${object[code].coins}\t${object[code].price}\n`
          }
          result += `Итог:\t\t${sum.amount}\t${sum.coins}\t${sum.price}`;
          return result;
        },
        makeSumOfOrders(ordersString) {
          var obj = app.convertOrderToObject(ordersString);
          return app.convertObjectToOrder(obj);
        },
        subtractOrder(ordersSum, order) {
          var er = new Error('Уменьшаемый заказ не содержит весь вычитаемый заказ.');
          var objSum = app.convertOrderToObject(ordersSum);
          var obj = app.convertOrderToObject(order);
          if (order !== '') {
            for (var code in obj) {
              if (objSum[code] === undefined) throw er;
              if (objSum[code].amount < obj[code].amount) throw er;
              if (objSum[code].amount == obj[code].amount) {
                delete objSum[code];
                continue;
              };
              objSum[code].amount -= obj[code].amount;  
            }
          }
          return app.convertObjectToOrder(objSum);
        },
        convertRCOrderToOrder(RCOrder) {
          var result = 'Код\tНаименование\tКол-во\tБаллы\tЦена\n';
          var RCOrderSpl = RCOrder.split('\n');
          var sum = {amount:0, coins:0, price:0};
          for (var line of RCOrderSpl) {
            if (line.includes('Сумма') || line.includes('\t\t') || line.includes('Код')) continue;
            var lineSpl = line.split('\t');
            sum.amount += lineSpl[3];
            sum.coins += lineSpl[4];
            sum.price += lineSpl[6];
            result += `${lineSpl[0]}\t${lineSpl[2]}\t${lineSpl[3]}\t${lineSpl[4]}\t${lineSpl[6]}\n`;
          }
          result += `Итог:\t\t${sum.amount}\t${sum.coins}\t${sum.price}`;
          return result;
        },
      };
      
      app.run();
    </script>
  </body>
</html>